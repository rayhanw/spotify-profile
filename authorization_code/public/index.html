<!DOCTYPE html>
<html>
	<head>
		<title>Youtify | Login</title>
		<link
			rel="stylesheet"
			href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
			integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="css/index.css" />
	</head>

	<body>
		<div class="container content">
			<div id="login">
				<h1>See your Spotify profile by pressing the button below</h1>
				<a href="/auth/spotify/login" class="btn btn-spotify"
					>Log in with Spotify</a
				>
			</div>
		</div>

		<script id="oauth-template" type="text/x-handlebars-template">
			<h2>oAuth info</h2>
			<dl class="dl-horizontal">
			  <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
			  <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
			</dl>
		</script>

		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script
			src="https://code.jquery.com/jquery-3.4.1.min.js"
			integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			crossorigin="anonymous"
		></script>
		<script>
			(function() {
				/**
				 * Obtains parameters from the hash of the URL
				 * @return Object
				 */
				console.log("inside script!");

				function getHashParams() {
					var hashParams = {};
					var e,
						r = /([^&;=]+)=?([^&;]*)/g,
						q = window.location.hash.substring(1);
					while ((e = r.exec(q))) {
						hashParams[e[1]] = decodeURIComponent(e[2]);
					}
					return hashParams;
				}

				var userProfileSource = document.getElementById("user-profile-template")
						.innerHTML,
					userProfileTemplate = Handlebars.compile(userProfileSource),
					userProfilePlaceholder = document.getElementById("user-profile");

				var oauthSource = document.getElementById("oauth-template").innerHTML,
					oauthTemplate = Handlebars.compile(oauthSource),
					oauthPlaceholder = document.getElementById("oauth");

				var params = getHashParams();

				var access_token = params.access_token,
					refresh_token = params.refresh_token,
					error = params.error;

				if (error) {
					alert("There was an error during the authentication");
				} else {
					if (access_token) {
						// render oauth info
						oauthPlaceholder.innerHTML = oauthTemplate({
							access_token: access_token,
							refresh_token: refresh_token
						});

						$.ajax({
							url: "https://api.spotify.com/v1/me",
							headers: {
								Authorization: "Bearer " + access_token
							},
							success: function(response) {
								userProfilePlaceholder.innerHTML = userProfileTemplate(
									response
								);

								$("#login").hide();
								$("#loggedin").show();
							}
						});
					} else {
						// render initial screen
						$("#login").show();
						$("#loggedin").hide();
					}

					document.getElementById("obtain-new-token").addEventListener(
						"click",
						function() {
							$.ajax({
								url: "/refresh_token",
								data: {
									refresh_token: refresh_token
								}
							}).done(function(data) {
								access_token = data.access_token;
								oauthPlaceholder.innerHTML = oauthTemplate({
									access_token: access_token,
									refresh_token: refresh_token
								});
							});
						},
						false
					);
				}
			})();
		</script>
	</body>
</html>
